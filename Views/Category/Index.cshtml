@model IEnumerable<StarFood.Models.Categoria>

@{
    ViewData["Title"] = "Category Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
 
<div class="container mt-4">
    <div class="rounded-box">
        <!-- SearchBox and AddButton -->
        <div class="row mb-3 align-items-center">
            <div class="col-md-10">
                <form class="d-flex" method="get" asp-action="Index">
                    <input class="form-control me-2" type="search" placeholder="Buscar por nombre" aria-label="Buscar" name="searchString">
                    <button class="btn btn-info" type="submit">Buscar</button>
                </form>
            </div>
            <div class="col-md-2">
                <a class="btn btn-info w-100" asp-action="Create">Crear</a>
            </div>
        </div> 
        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>@Html.DisplayNameFor(model => model.FirstOrDefault().IDCategoria)</th>
                        <th>@Html.DisplayNameFor(model => model.FirstOrDefault().Nombre)</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="categoryTableBody">
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@Html.DisplayFor(modelItem => item.IDCategoria)</td>
                            <td>@Html.DisplayFor(modelItem => item.Nombre)</td>
                            <td>
                                <button class="btn btn-info btn-sm edit-btn" data-id="@item.IDCategoria">Editar</button>
                                <button class="btn btn-danger btn-sm delete-btn" data-id="@item.IDCategoria">Borrar</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui/1.12.1/jquery-ui.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" rel="stylesheet" />

    <script>
        $(document).ready(function () {
            loadCategories();

            $('#categoryForm').on('submit', function (e) {
                e.preventDefault();
                var categoria = {
                    IDCategoria: $('#IDCategoria').val(),
                    Nombre: $('#Nombre').val()
                };

                if (categoria.IDCategoria) {
                    $.ajax({
                        url: '@Url.Action("Edit", "Category")',
                        type: 'POST',
                        data: JSON.stringify(categoria),
                        contentType: 'application/json; charset=utf-8',
                        success: function (response) {
                            if (response.success) {
                                loadCategories();
                                $('#categoryForm')[0].reset();
                            } else {
                                alert('Error al actualizar la categoría.');
                            }
                        }
                    });
                } else {
                    $.ajax({
                        url: '@Url.Action("Create", "Category")',
                        type: 'POST',
                        data: JSON.stringify(categoria),
                        contentType: 'application/json',
                        success: function (response) {
                            if (response.success) {
                                loadCategories();
                                $('#categoryForm')[0].reset();
                            } else {
                                alert('Error al añadir la categoría.');
                            }
                        }
                    });
                }
            });

            $('body').on('click', '.edit-btn', function () {
                var id = $(this).data('id');
                $.get('@Url.Action("Edit", "Category")/' + id, function (data) {
                    $('#IDCategoria').val(data.idCategoria);
                    $('#Nombre').val(data.nombre);
                    openCategoryForm();
                });
            });

            $('body').on('click', '.delete-btn', function () {
                if (confirm('¿Estás seguro de que quieres eliminar esta categoría?')) {
                    var id = $(this).data('id');
                    $.ajax({
                        url: '@Url.Action("Delete", "Category")/' + id,
                        type: 'DELETE',
                        success: function (response) {
                            if (response.success) {
                                loadCategories();
                            } else {
                                alert('Error al eliminar la categoría.');
                            }
                        }
                    });
                }
            });

            function loadCategories() {
                $.get('@Url.Action("GetAll", "Category")', function (response) {
                    var rows = '';
                    response.data.forEach(function (category) {
                        rows += '<tr>';
                        rows += '<td>' + category.idCategoria + '</td>';
                        rows += '<td>' + category.nombre + '</td>';
                        rows += '<td>';
                        rows += '<button class="btn btn-info btn-sm edit-btn" data-id="' + category.idCategoria + '">Editar</button> ';
                        rows += '<button class="btn btn-danger btn-sm delete-btn" data-id="' + category.idCategoria + '">Eliminar</button>';
                        rows += '</td>';
                        rows += '</tr>';
                    });
                    $('#categoryTableBody').html(rows);
                });
            }

            function openCategoryForm() {
                $('#categoryFormContainer').dialog({
                    modal: true,
                    width: 400,
                    title: "Añadir/Editar Categoría"
                });
            }
        });
    </script>
}

<div id="categoryFormContainer" style="display:none;">
    <form id="categoryForm">
        <input type="hidden" id="IDCategoria" name="IDCategoria" />
        <div class="form-group">
            <label for="NombreCategoria">Nombre de la Categoría:</label>
            <input type="text" id="NombreCategoria" name="NombreCategoria" class="form-control" required />
        </div>
        <button type="submit" class="btn btn-primary">Guardar</button>
        <button type="reset" class="btn btn-secondary">Cancelar</button>
    </form>
</div>
